@using WeddingWebsite.Models.Todo
@using WeddingWebsite.Services
@using WeddingWebsite.Components.Elements

@inject ITodoService TodoService

@if (Item == null)
{
    <div>ERROR: Item not found.</div>
    return;
}

<div class="todo-item">
    <div class="todo-text">@Item.Text</div>
    <MudSpacer/>
    @if (Item.OwnerEmail != null)
    {
        <div class="todo-owner">Owner: @Item.OwnerEmail</div>
    }
    else
    {
        <div class="todo-owner">No owner assigned</div>
    }
    @if (Item.Status is TodoItemStatus.Waiting or TodoItemStatus.Completed)
    {
        <Button OnClick="MarkItemAsActionRequired">Action Required</Button>
    }
    @if (Item.Status == TodoItemStatus.ActionRequired)
    {
        <Button OnClick="MarkItemAsWaiting">Waiting</Button>
    }
    @if (Item.Status is TodoItemStatus.ActionRequired or TodoItemStatus.Waiting)
    {
        <Button OnClick="MarkItemAsCompleted">Done</Button>
    }
</div>

@code {
    [Parameter]
    public TodoItem? Item { get; set; }
    
    [Parameter]
    public Action? ParentStateHasChanged { get; set; }
    
    private void ApplyToItem(Action<TodoItem> action)
    {
        if (Item == null) return;
        action(Item);
        Item = TodoService.GetTodoItem(Item.Id);
        StateHasChanged();
        ParentStateHasChanged?.Invoke();
    }

    private void MarkItemAsCompleted()
    {
        ApplyToItem(item => TodoService.MarkItemAsCompleted(item.Id));
    }
    
    private void MarkItemAsWaiting()
    {
        ApplyToItem(item => TodoService.MarkItemAsWaiting(item.Id, TimeSpan.FromDays(3)));
    }
    
    private void MarkItemAsActionRequired()
    {
        ApplyToItem(item => TodoService.MarkItemAsActionRequired(item.Id));
    }
}
