@using WeddingWebsite.Models.WebsiteElement
@using WeddingWebsite.Models.WeddingDetails
@using WeddingWebsite.Components.Containers
@using WeddingWebsite.Components.Elements
@using WeddingWebsite.Models

@inject IWeddingDetails WeddingDetails

<MudTimeline TimelinePosition="TimelinePosition.Alternate">
    @foreach (var item in timelineItems) {
        <MudTimelineItem Size=@item.GetDotSize() Color=Color.Primary Elevation="25">
            <ItemOpposite>
                <MudText Color="Color.Primary" Typo="Typo.h6">@item.Time</MudText>
            </ItemOpposite>
            <ItemContent>
                <OutlinedBox Image=@item.Image MapsLocation=@item.MapsLocation>
                    <h2>@item.Title</h2>
                    <p class="event-description">@((MarkupString)item.Description)</p>
                    @foreach (var modal in item.Modals) {
                        <ModalButton Modal="@modal"/>
                    }
                    <div class="event-location">
                        <MudIcon Icon="@Icons.Material.Filled.LocationOn"/>
                        <span>@item.VenueName</span>
                    </div>
                </OutlinedBox>
            </ItemContent>
            <ItemDot>
                @if (item.Icon != null) {
                    <MudIcon Icon=@item.Icon Style="width: 100%" />
                }
            </ItemDot>
        </MudTimelineItem>
    }
</MudTimeline>

@code {

    private IEnumerable<TimelineItem> timelineItems = [];
    
    protected override void OnInitialized()
    {
        string? previousVenueName = null;
        TimeOnly? previousEndTime = null;
        foreach (var ev in WeddingDetails.Events)
        {
            // Generate a timeline item for the venue change
            if (previousVenueName != ev.Venue.Name) {
                timelineItems = timelineItems.Append(new TimelineItem (
                    type : TimelineItemType.VenueChange,
                    time : previousEndTime?.ToShortTimeString() ?? "Start",
                    title : "Transport",
                    description : ev.Venue.Directions?.DrivingTimeInMinutes != null ? ev.Venue.Directions?.DrivingTimeInMinutes + " min drive." : "Travel to the venue.",
                    venueName : previousVenueName != null ? previousVenueName + " → " + ev.Venue.Name : "Your House → " + ev.Venue.Name,
                    modals : [new WeddingModal("Travel Directions", "TODO")],
                    icon: Icons.Material.Filled.DirectionsCar,
                    image : ev.Venue.Directions?.CoverImage,
                    mapsLocation: ev.Venue.Directions?.CoverImage == null ? ev.Venue.Location : null
                ));
            }
            
            // Update previous venue
            previousVenueName = ev.Venue.Name;
            previousEndTime = ev.End;
            
            // Generate a timeline item for the event itself
            timelineItems = timelineItems.Append(new TimelineItem
            (
                TimelineItemType.Event,
                ev.Start.ToShortTimeString(),
                ev.Name,
                ev.Description,
                ev.Venue.Name,
                ev.Modals,
                ev.Icon,
                ev.Image
            ));
        }
        
        // Finally, add an accommodation item if appropriate
        if (WeddingDetails.AccommodationDetails.Hotels.Any()) {
            timelineItems = timelineItems.Append(new TimelineItem(
                TimelineItemType.Accommodation,
                previousEndTime?.ToShortTimeString() ?? "??:??",
                "Accommodation",
                WeddingDetails.AccommodationDetails.Description ?? "If you would like to book accommodation, here are some recommendations",
                WeddingDetails.AccommodationDetails.Hotels.First().Name + " (or " + (WeddingDetails.AccommodationDetails.Hotels.Count-1) + " others)",
                [new WeddingModal("Suggested Hotels", "TODO: Info about all the hotels")],
                @Icons.Material.Filled.Hotel,
                WeddingDetails.AccommodationDetails.Image
            ));
        }
    }
    
    private class TimelineItem (
        TimelineItemType type,
        string time,
        string title,
        string description,
        string venueName,
        IEnumerable<WeddingModal> modals,
        string? icon = null,
        WebsiteImage? image = null,
        Location? mapsLocation = null
    )
    {
        public TimelineItemType Type { get; } = type;
        public string Time { get; } = time;
        public string Title { get; } = title;
        public string Description { get; } = description;
        public string VenueName { get; } = venueName;
        public IEnumerable<WeddingModal> Modals { get; } = modals;
        public string? Icon { get; } = icon;
        public WebsiteImage? Image { get; } = image;
        public Location? MapsLocation { get; } = mapsLocation;
        
        public Size GetDotSize() => Icon == null ? Size.Small : Size.Medium;
    };
    
    private enum TimelineItemType
    {
        VenueChange,
        Event,
        Accommodation
    }
}
